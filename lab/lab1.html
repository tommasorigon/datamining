<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tommaso Rigon">

<title>Lab 1 (Computations for linear models)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab1_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab1_files/libs/quarto-html/quarto.js"></script>
<script src="lab1_files/libs/quarto-html/popper.min.js"></script>
<script src="lab1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab1_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab1_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab1_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#homepage" id="toc-homepage" class="nav-link active" data-scroll-target="#homepage">Homepage</a>
  <ul class="collapse">
  <li><a href="#the-auto-dataset" id="toc-the-auto-dataset" class="nav-link" data-scroll-target="#the-auto-dataset">The <code>auto</code> dataset</a></li>
  <li><a href="#ordinary-least-squares-naïve-solution" id="toc-ordinary-least-squares-naïve-solution" class="nav-link" data-scroll-target="#ordinary-least-squares-naïve-solution">Ordinary least squares (naïve solution)</a></li>
  <li><a href="#normal-equations" id="toc-normal-equations" class="nav-link" data-scroll-target="#normal-equations">Normal equations</a></li>
  <li><a href="#benchmarking-i" id="toc-benchmarking-i" class="nav-link" data-scroll-target="#benchmarking-i">Benchmarking I</a></li>
  <li><a href="#cholesky-factorization" id="toc-cholesky-factorization" class="nav-link" data-scroll-target="#cholesky-factorization">Cholesky factorization</a></li>
  <li><a href="#benchmarking-ii" id="toc-benchmarking-ii" class="nav-link" data-scroll-target="#benchmarking-ii">Benchmarking II</a></li>
  <li><a href="#cholesky-and-ols-variance" id="toc-cholesky-and-ols-variance" class="nav-link" data-scroll-target="#cholesky-and-ols-variance">Cholesky and OLS variance</a></li>
  <li><a href="#qr-factorization" id="toc-qr-factorization" class="nav-link" data-scroll-target="#qr-factorization">QR factorization</a></li>
  <li><a href="#benchmark-iii" id="toc-benchmark-iii" class="nav-link" data-scroll-target="#benchmark-iii">Benchmark III</a></li>
  <li><a href="#numerical-precision-of-qr" id="toc-numerical-precision-of-qr" class="nav-link" data-scroll-target="#numerical-precision-of-qr">Numerical precision of QR</a></li>
  </ul></li>
  <li><a href="#iterative-methods" id="toc-iterative-methods" class="nav-link" data-scroll-target="#iterative-methods">Iterative methods</a>
  <ul class="collapse">
  <li><a href="#the-drivers-dataset" id="toc-the-drivers-dataset" class="nav-link" data-scroll-target="#the-drivers-dataset">The <code>drivers</code> dataset</a></li>
  <li><a href="#benchmark" id="toc-benchmark" class="nav-link" data-scroll-target="#benchmark">Benchmark</a></li>
  <li><a href="#recursive-estimates" id="toc-recursive-estimates" class="nav-link" data-scroll-target="#recursive-estimates">Recursive estimates</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 1 (Computations for linear models)</h1>
<p class="subtitle lead">Data Mining - CdL CLAMSES</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><span class="orange">Tommaso Rigon</span> </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <em>Università degli Studi di Milano-Bicocca</em>
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="homepage" class="level1">
<h1><a href="../index.html">Homepage</a></h1>
<p>This is the first lab of the course <a href="../index.html">Data Mining</a>. Code is not fully commented, because it will be executed and described in-class.</p>
<p>The associated code <a href="../code/lab1.R">lab1.R</a> is available online.</p>
<section id="the-auto-dataset" class="level2">
<h2 class="anchored" data-anchor-id="the-auto-dataset">The <code>auto</code> dataset</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The dataset can be downloaded here: https://tommasorigon.github.io/datamining/data/auto.txt</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>auto <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"../data/auto.txt"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the variables we need</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>auto <span class="ot">&lt;-</span> <span class="fu">subset</span>(auto, <span class="at">select =</span> <span class="fu">c</span>(city.distance, engine.size, n.cylinders, curb.weight, fuel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new variable (cylinders)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>auto<span class="sc">$</span>cylinders2 <span class="ot">&lt;-</span> <span class="fu">factor</span>(auto<span class="sc">$</span>n.cylinders <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the final model we obtained in Unit A, after a long modelling process</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>m_final <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(city.distance) <span class="sc">~</span> <span class="fu">I</span>(<span class="fu">log</span>(engine.size)) <span class="sc">+</span> <span class="fu">I</span>(<span class="fu">log</span>(curb.weight)) <span class="sc">+</span> fuel <span class="sc">+</span> cylinders2, <span class="at">data =</span> auto)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the results</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_final)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = log(city.distance) ~ I(log(engine.size)) + I(log(curb.weight)) + 
    fuel + cylinders2, data = auto)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.204657 -0.052425 -0.002914  0.049706  0.313410 

Coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)          9.42293    0.48202  19.549  &lt; 2e-16 ***
I(log(engine.size)) -0.17974    0.05130  -3.504 0.000567 ***
I(log(curb.weight)) -0.94262    0.07214 -13.066  &lt; 2e-16 ***
fuelgas             -0.35253    0.02212 -15.934  &lt; 2e-16 ***
cylinders2TRUE      -0.48143    0.05176  -9.301  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.08961 on 198 degrees of freedom
Multiple R-squared:  0.8819,    Adjusted R-squared:  0.8795 
F-statistic: 369.7 on 4 and 198 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Design matrix obtained from the model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="fu">log</span>(city.distance) <span class="sc">~</span> <span class="fu">I</span>(<span class="fu">log</span>(engine.size)) <span class="sc">+</span> <span class="fu">I</span>(<span class="fu">log</span>(curb.weight)) <span class="sc">+</span> fuel <span class="sc">+</span> cylinders2, <span class="at">data =</span> auto)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">log</span>(auto<span class="sc">$</span>city.distance)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional. I remove the column names to improve the HTML readibility</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 203   5</code></pre>
</div>
</div>
</section>
<section id="ordinary-least-squares-naïve-solution" class="level2">
<h2 class="anchored" data-anchor-id="ordinary-least-squares-naïve-solution">Ordinary least squares (naïve solution)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Least squares, the naive way. </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This provides the correct numbers in simple examples, but it is inefficient AND numerically inaccurate</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> X) <span class="sc">%*%</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,]  9.4229256
[2,] -0.1797370
[3,] -0.9426171
[4,] -0.3525282
[5,] -0.4814288</code></pre>
</div>
</div>
</section>
<section id="normal-equations" class="level2">
<h2 class="anchored" data-anchor-id="normal-equations">Normal equations</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sufficients statistics for this model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>XtX <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(X)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>Xty <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(X, y)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(XtX, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]    [,3]   [,4] [,5]
[1,]  203.0 139.7  1428.2  183.0  4.0
[2,]  139.7 112.4   992.7  124.2  0.7
[3,] 1428.2 992.7 10056.5 1285.0 28.0
[4,]  183.0 124.2  1285.0  183.0  4.0
[5,]    4.0   0.7    28.0    4.0  4.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(Xty, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]
[1,]  475.03
[2,]  316.21
[3,] 3333.80
[4,]  424.36
[5,]    7.85</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The next algorithm make use of normal equations, but it does not know that XtX is positive definite</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ols_solve <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  XtX <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(X)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  Xty <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(X, y)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(XtX, Xty)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_solve</span>(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,]  9.4229256
[2,] -0.1797370
[3,] -0.9426171
[4,] -0.3525282
[5,] -0.4814288</code></pre>
</div>
</div>
</section>
<section id="benchmarking-i" class="level2">
<h2 class="anchored" data-anchor-id="benchmarking-i">Benchmarking I</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark) <span class="co"># Needs to be installed</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the speed of execution</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">matrix_inversion =</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> X) <span class="sc">%*%</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> y,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear_system =</span> <span class="fu">ols_solve</span>(X, y), <span class="at">times =</span> <span class="dv">1000</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the timings</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>times</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
             expr    min     lq     mean median     uq      max neval
 matrix_inversion 25.379 26.240 27.38374 26.978 27.511   58.917  1000
    linear_system  8.159  8.405  9.74488  8.569  8.774 1023.729  1000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="lab1_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="1800"></p>
</div>
</div>
</section>
<section id="cholesky-factorization" class="level2">
<h2 class="anchored" data-anchor-id="cholesky-factorization">Cholesky factorization</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">chol</span>(XtX)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]    [,3]   [,4]   [,5]
[1,] 14.248 9.804 100.242 12.844  0.281
[2,]  0.000 4.040   2.446 -0.417 -0.512
[3,]  0.000 0.000   1.417 -1.059  0.776
[4,]  0.000 0.000   0.000  4.091  0.245
[5,]  0.000 0.000   0.000  0.000  1.731</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm that this is the appropriate Cholesky decomposition</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(XtX, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         [,1]    [,2]      [,3]     [,4]   [,5]
[1,]  203.000 139.685  1428.233  183.000  4.000
[2,]  139.685 112.438   992.651  124.239  0.683
[3,] 1428.233 992.651 10056.513 1285.000 27.989
[4,]  183.000 124.239  1285.000  183.000  4.000
[5,]    4.000   0.683    27.989    4.000  4.000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">t</span>(R) <span class="sc">%*%</span> R, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         [,1]    [,2]      [,3]     [,4]   [,5]
[1,]  203.000 139.685  1428.233  183.000  4.000
[2,]  139.685 112.438   992.651  124.239  0.683
[3,] 1428.233 992.651 10056.513 1285.000 27.989
[4,]  183.000 124.239  1285.000  183.000  4.000
[5,]    4.000   0.683    27.989    4.000  4.000</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordinary least squares with Cholesky</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ols_chol <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  XtX <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(X)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  Xty <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(X, y)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">chol</span>(XtX)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  beta_hat <span class="ot">&lt;-</span> <span class="fu">backsolve</span>(R, <span class="fu">forwardsolve</span>(<span class="fu">t</span>(R), Xty))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  beta_hat</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_chol</span>(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,]  9.4229256
[2,] -0.1797370
[3,] -0.9426171
[4,] -0.3525282
[5,] -0.4814288</code></pre>
</div>
</div>
</section>
<section id="benchmarking-ii" class="level2">
<h2 class="anchored" data-anchor-id="benchmarking-ii">Benchmarking II</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the speed of execution</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">matrix_inversion =</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> X) <span class="sc">%*%</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> y,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear_system =</span> <span class="fu">ols_solve</span>(X, y),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cholesky =</span> <span class="fu">ols_chol</span>(X, y),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">1000</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the timings</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>times</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
             expr    min     lq     mean median      uq      max neval
 matrix_inversion 24.846 26.035 27.47180 26.855 28.0030   54.325  1000
    linear_system  8.159  8.446 10.84356  8.610  8.9790 1942.744  1000
         cholesky 11.480 11.972 14.28174 12.259 13.0585 1597.401  1000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="lab1_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="1800"></p>
</div>
</div>
</section>
<section id="cholesky-and-ols-variance" class="level2">
<h2 class="anchored" data-anchor-id="cholesky-and-ols-variance">Cholesky and OLS variance</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># However, the Cholesky decomposition is giving us much more.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># To get the variance of the estimates we need to compute the inverse of XtX</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Traditional inverse (not ideal)</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(XtX)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]        [,2]        [,3]        [,4]        [,5]
[1,] 28.935354  2.69541474 -4.32398693 -0.43108899  1.29139234
[2,]  2.695415  0.32770163 -0.41170450 -0.03045695  0.15988406
[3,] -4.323987 -0.41170450  0.64816416  0.05649664 -0.19756110
[4,] -0.431089 -0.03045695  0.05649664  0.06095633 -0.01998578
[5,]  1.291392  0.15988406 -0.19756110 -0.01998578  0.33367682</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cholesky inverse</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chol2inv</span>(R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]        [,2]        [,3]        [,4]        [,5]
[1,] 28.935354  2.69541474 -4.32398693 -0.43108899  1.29139234
[2,]  2.695415  0.32770163 -0.41170450 -0.03045695  0.15988406
[3,] -4.323987 -0.41170450  0.64816416  0.05649664 -0.19756110
[4,] -0.431089 -0.03045695  0.05649664  0.06095633 -0.01998578
[5,]  1.291392  0.15988406 -0.19756110 -0.01998578  0.33367682</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(<span class="at">matrix_inversion =</span> <span class="fu">solve</span>(XtX), <span class="at">cholesky =</span> <span class="fu">chol2inv</span>(R))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: nanoseconds
             expr  min   lq    mean median   uq   max neval
 matrix_inversion 5699 5863 6358.69   5986 6150 27224   100
         cholesky  697  779  911.84    820  861  8282   100</code></pre>
</div>
</div>
</section>
<section id="qr-factorization" class="level2">
<h2 class="anchored" data-anchor-id="qr-factorization">QR factorization</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This specific linear regression model is fairly well-conditioned</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Any method (even the naive ones) are going to work just fine</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kappa</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> X, <span class="at">exact =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 314590.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that this coincide with:</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kappa</span>(X, <span class="at">exact =</span> <span class="cn">TRUE</span>)<span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 314590.3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-implementation via Gram-Schmidt</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>factorizationQR <span class="ot">&lt;-</span> <span class="cf">function</span>(X) {</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  Q <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, p)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, p, p)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    Zj <span class="ot">&lt;-</span> X[, j]</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (j <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(j <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        R[k, j] <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(Q[, k], X[, j])</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        Zj <span class="ot">&lt;-</span> Zj <span class="sc">-</span> R[k, j] <span class="sc">*</span> Q[, k]</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    R[j, j] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">crossprod</span>(Zj))</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    Q[, j] <span class="ot">&lt;-</span> Zj <span class="sc">/</span> R[j, j]</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Q =</span> Q, <span class="at">R =</span> R))</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let us compute the QR factorization</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>QR <span class="ot">&lt;-</span> <span class="fu">factorizationQR</span>(X)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This is an orthogonal matrix</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">crossprod</span>(QR<span class="sc">$</span>Q), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5]
[1,]    1    0    0    0    0
[2,]    0    1    0    0    0
[3,]    0    0    1    0    0
[4,]    0    0    0    1    0
[5,]    0    0    0    0    1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This coincide with the Cholesky</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(QR<span class="sc">$</span>R, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]    [,3]   [,4]   [,5]
[1,] 14.248 9.804 100.242 12.844  0.281
[2,]  0.000 4.040   2.446 -0.417 -0.512
[3,]  0.000 0.000   1.417 -1.059  0.776
[4,]  0.000 0.000   0.000  4.091  0.245
[5,]  0.000 0.000   0.000  0.000  1.731</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]    [,3]   [,4]   [,5]
[1,] 14.248 9.804 100.242 12.844  0.281
[2,]  0.000 4.040   2.446 -0.417 -0.512
[3,]  0.000 0.000   1.417 -1.059  0.776
[4,]  0.000 0.000   0.000  4.091  0.245
[5,]  0.000 0.000   0.000  0.000  1.731</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>ols_QR <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  qr_obj <span class="ot">&lt;-</span> <span class="fu">factorizationQR</span>(X)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  Q <span class="ot">&lt;-</span> qr_obj<span class="sc">$</span>Q</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> qr_obj<span class="sc">$</span>R</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  Qty <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(Q, y)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  beta_hat <span class="ot">&lt;-</span> <span class="fu">backsolve</span>(R, Qty)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  beta_hat</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_QR</span>(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,]  9.4229256
[2,] -0.1797370
[3,] -0.9426171
[4,] -0.3525282
[5,] -0.4814288</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Be careful, here pivoting is performed</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This means the QR might be different with that of factorizationQR</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>QR_obj <span class="ot">&lt;-</span> <span class="fu">qr</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ols_QR <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  qr_obj <span class="ot">&lt;-</span> <span class="fu">qr</span>(X)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">qr.coef</span>(qr_obj, y)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_QR</span>(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  9.4229256 -0.1797370 -0.9426171 -0.3525282 -0.4814288</code></pre>
</div>
</div>
</section>
<section id="benchmark-iii" class="level2">
<h2 class="anchored" data-anchor-id="benchmark-iii">Benchmark III</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the speed of execution</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">matrix_inversion =</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> X) <span class="sc">%*%</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> y,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear_system =</span> <span class="fu">ols_solve</span>(X, y),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cholesky =</span> <span class="fu">ols_chol</span>(X, y),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">QR =</span> <span class="fu">ols_QR</span>(X, y),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">1000</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the timings</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>times</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
             expr    min     lq      mean median      uq      max neval
 matrix_inversion 24.969 26.199 29.786049 26.896 27.8800 2147.580  1000
    linear_system  8.200  8.569  9.105608  8.774  9.0405   40.016  1000
         cholesky 11.521 12.095 12.798560 12.382 12.7920   25.666  1000
               QR 24.846 26.363 30.550863 27.347 28.7820 1816.915  1000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="lab1_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="1800"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated coefficients</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qr.coef</span>(QR_obj, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  9.4229256 -0.1797370 -0.9426171 -0.3525282 -0.4814288</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted values</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">predict</span>(m_final))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1        2        3        4        5        6 
2.286616 2.286616 2.161938 2.399751 2.181562 2.293801 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">qr.fitted</span>(QR_obj, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.286616 2.286616 2.161938 2.399751 2.181562 2.293801</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">residuals</span>(m_final))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          1           2           3           4           5           6 
-0.09742398 -0.09742398 -0.07279323 -0.07706922 -0.14659471 -0.20465668 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">qr.resid</span>(QR_obj, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.09742398 -0.09742398 -0.07279323 -0.07706922 -0.14659471 -0.20465668</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Influence points</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">influence</span>(m_final)<span class="sc">$</span>hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          1           2           3           4           5           6 
0.005964967 0.005964967 0.008907262 0.006511439 0.008928448 0.008484793 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">rowSums</span>(<span class="fu">qr.Q</span>(QR_obj)<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.005964967 0.005964967 0.008907262 0.006511439 0.008928448 0.008484793</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse of XtX</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(XtX)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]        [,2]        [,3]        [,4]        [,5]
[1,] 28.935354  2.69541474 -4.32398693 -0.43108899  1.29139234
[2,]  2.695415  0.32770163 -0.41170450 -0.03045695  0.15988406
[3,] -4.323987 -0.41170450  0.64816416  0.05649664 -0.19756110
[4,] -0.431089 -0.03045695  0.05649664  0.06095633 -0.01998578
[5,]  1.291392  0.15988406 -0.19756110 -0.01998578  0.33367682</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chol2inv</span>(<span class="fu">qr.R</span>(QR_obj))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]        [,2]        [,3]        [,4]        [,5]
[1,] 28.935354  2.69541474 -4.32398693 -0.43108899  1.29139234
[2,]  2.695415  0.32770163 -0.41170450 -0.03045695  0.15988406
[3,] -4.323987 -0.41170450  0.64816416  0.05649664 -0.19756110
[4,] -0.431089 -0.03045695  0.05649664  0.06095633 -0.01998578
[5,]  1.291392  0.15988406 -0.19756110 -0.01998578  0.33367682</code></pre>
</div>
</div>
</section>
<section id="numerical-precision-of-qr" class="level2">
<h2 class="anchored" data-anchor-id="numerical-precision-of-qr">Numerical precision of QR</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fl">1e-7</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, a, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, a))</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>manual <span class="ot">&lt;-</span> <span class="fu">rbind</span>((<span class="dv">1</span> <span class="sc">-</span> a) <span class="sc">/</span> (<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> a<span class="sc">^</span><span class="dv">4</span>) <span class="sc">+</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">-</span> a<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> a<span class="sc">^</span><span class="dv">4</span>), <span class="dv">1</span> <span class="sc">/</span> (<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> a<span class="sc">^</span><span class="dv">4</span>) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> a) <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">-</span> a<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">/</span> (<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> a<span class="sc">^</span><span class="dv">4</span>))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ols_solve</span>(X, y), <span class="at">digits =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               [,1]
[1,]  5004000.08333
[2,] -5003999.08333</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ols_chol</span>(X, y), <span class="at">digits =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               [,1]
[1,]  5060224.80337
[2,] -5060223.80337</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ols_QR</span>(X, y), <span class="at">digits =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  5000000.5 -4999999.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(manual, <span class="at">digits =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,]  5000000.5
[2,] -4999999.5</code></pre>
</div>
</div>
</section>
</section>
<section id="iterative-methods" class="level1">
<h1>Iterative methods</h1>
<section id="the-drivers-dataset" class="level2">
<h2 class="anchored" data-anchor-id="the-drivers-dataset">The <code>drivers</code> dataset</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional information</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Source of the data: https://dati.mit.gov.it/hfs/patenti_Lombardia.csv</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Documentation: http://dati.mit.gov.it/catalog/dataset/patenti</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Author:   Direzione generale per la motorizzazione - Div7 - Centro elaborazione dati motorizzazione</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Last update:  21 December 2022, 17:16 (UTC+01:00)</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Created:  20 February 2022, 18:21 (UTC+01:00)</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal extension (end)  31 December 2019</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>drivers <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/drivers2.csv"</span>, <span class="at">n_max =</span> <span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ```{r} -->
<!-- # Change the name of the columns -->
<!-- colnames(drivers) <- c("id", "birth", "town", "city", "region", "state", "gender", "category", "date", "habilit", "date_habilit", "expiration", "date_foreigners", "points") -->
<!-- # Change the format of the date -->
<!-- drivers <- drivers %>% mutate(date = ymd_hms(date), experience = 2019 - year(date), age = 2019 - birth) -->
<!-- # Select patent B and other things -->
<!-- drivers <- drivers %>% -->
<!--   filter(category == "B", is.na(state), !is.na(points)) %>% -->
<!--   filter(experience > 0) -->
<!-- # Remove irrelevant columns -->
<!-- drivers <- drivers %>% select(-c(id, category, state, date_foreigners, expiration, date_habilit, birth, date, region)) -->
<!-- drivers <- drivers %>% mutate(hazard = sqrt(-(points - 30))) -->
<!-- drivers <- na.omit(drivers) -->
<!-- glimpse(drivers) -->
<!-- summary(drivers) -->
<!-- write_csv(drivers, "../data/drivers2.csv") -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Design matrix obtained from the model</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(hazard <span class="sc">~</span> <span class="fu">poly</span>(age, <span class="dv">10</span>) <span class="sc">+</span> <span class="fu">poly</span>(experience, <span class="dv">10</span>) <span class="sc">+</span> habilit <span class="sc">+</span> gender <span class="sc">+</span> city, <span class="at">data =</span> drivers)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> drivers<span class="sc">$</span>hazard</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000    33</code></pre>
</div>
</div>
</section>
<section id="benchmark" class="level2">
<h2 class="anchored" data-anchor-id="benchmark">Benchmark</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the speed of execution</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">matrix_inversion =</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> X) <span class="sc">%*%</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> y,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear_system =</span> <span class="fu">ols_solve</span>(X, y),</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cholesky =</span> <span class="fu">ols_chol</span>(X, y),</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">QR =</span> <span class="fu">ols_QR</span>(X, y),</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">50</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the timings</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>times</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
             expr      min       lq      mean   median        uq       max
 matrix_inversion 8.149898 8.312299  8.709106 8.405451  8.648745 10.712234
    linear_system 6.844089 6.876602  6.925441 6.899665  6.961103  7.162249
         cholesky 6.841916 6.867992  6.926273 6.889517  6.961718  7.330513
               QR 9.150462 9.260629 10.622507 9.922861 10.766846 39.465247
 neval
    50
    50
    50
    50</code></pre>
</div>
</div>
</section>
<section id="recursive-estimates" class="level2">
<h2 class="anchored" data-anchor-id="recursive-estimates">Recursive estimates</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(biglm)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>drivers_chunk1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/drivers2.csv"</span>, </span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n_max =</span> <span class="dv">100000</span>, <span class="at">skip =</span> <span class="dv">0</span>, <span class="at">col_names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>name_cols <span class="ot">&lt;-</span> <span class="fu">colnames</span>(drivers_chunk1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>m_big <span class="ot">&lt;-</span> <span class="fu">biglm</span>(hazard <span class="sc">~</span> <span class="fu">poly</span>(age, <span class="dv">10</span>) <span class="sc">+</span> <span class="fu">poly</span>(experience, <span class="dv">10</span>) <span class="sc">+</span> habilit <span class="sc">+</span> gender <span class="sc">+</span>  city, </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> drivers_chunk1)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_big)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Large data regression model: biglm(hazard ~ poly(age, 10) + poly(experience, 10) + habilit + 
    gender + city, data = drivers_chunk1)
Sample size =  100000 
                              Coef     (95%      CI)     SE      p
(Intercept)                 0.5025   0.4790   0.5260 0.0118 0.0000
poly(age, 10)1            -32.3565 -38.9120 -25.8010 3.2777 0.0000
poly(age, 10)2             -8.8621 -14.9682  -2.7561 3.0530 0.0037
poly(age, 10)3              3.5942  -1.5506   8.7391 2.5724 0.1624
poly(age, 10)4             -0.5864  -4.5715   3.3986 1.9925 0.7685
poly(age, 10)5              0.5780  -3.0051   4.1612 1.7916 0.7470
poly(age, 10)6              0.7048  -2.6491   4.0587 1.6770 0.6743
poly(age, 10)7             -1.2556  -4.4928   1.9817 1.6186 0.4379
poly(age, 10)8             -2.2750  -5.1402   0.5903 1.4326 0.1123
poly(age, 10)9              1.1176  -1.3892   3.6244 1.2534 0.3726
poly(age, 10)10             2.1699  -0.0412   4.3810 1.1055 0.0497
poly(experience, 10)1     -57.5573 -64.8101 -50.3044 3.6264 0.0000
poly(experience, 10)2      65.4595  59.6770  71.2420 2.8913 0.0000
poly(experience, 10)3     -42.9206 -47.5879 -38.2534 2.3336 0.0000
poly(experience, 10)4      32.0091  28.2193  35.7988 1.8949 0.0000
poly(experience, 10)5     -20.9381 -24.2519 -17.6242 1.6569 0.0000
poly(experience, 10)6       8.1923   4.7802  11.6045 1.7061 0.0000
poly(experience, 10)7      -0.2951  -3.4603   2.8702 1.5826 0.8521
poly(experience, 10)8      -4.6204  -7.7604  -1.4804 1.5700 0.0033
poly(experience, 10)9       4.3903   1.5296   7.2511 1.4304 0.0021
poly(experience, 10)10     -1.7464  -4.4530   0.9602 1.3533 0.1969
habilitS                    0.1616   0.1392   0.1839 0.0112 0.0000
genderM                     0.3058   0.2915   0.3201 0.0071 0.0000
cityBRESCIA                 0.1511   0.1207   0.1814 0.0152 0.0000
cityCOMO                    0.0259  -0.0008   0.0526 0.0133 0.0520
cityCREMONA                 0.1309   0.0670   0.1949 0.0320 0.0000
cityLECCO                  -0.0243  -0.0593   0.0108 0.0175 0.1659
cityLODI                    0.0582   0.0227   0.0938 0.0178 0.0010
cityMANTOVA                 0.2532   0.1771   0.3293 0.0381 0.0000
cityMILANO                  0.1471   0.1234   0.1709 0.0119 0.0000
cityMONZA E DELLA BRIANZA  -0.0109  -0.0444   0.0227 0.0168 0.5177
cityPAVIA                   0.2479   0.2115   0.2843 0.0182 0.0000
citySONDRIO                -0.0613  -0.1129  -0.0097 0.0258 0.0174
cityVARESE                  0.0150  -0.0153   0.0453 0.0151 0.3221</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(drivers_chunk1)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>() <span class="co"># Free unused R memory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          used (Mb) gc trigger  (Mb) limit (Mb) max used  (Mb)
Ncells 1000725 53.5    1779550  95.1         NA  1693400  90.5
Vcells 2276108 17.4   14503427 110.7      16384 18129283 138.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>drivers_chunk2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/drivers2.csv"</span>, </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n_max =</span> <span class="dv">100000</span>, <span class="at">skip =</span> <span class="dv">100000</span>, <span class="at">col_names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(drivers_chunk2) <span class="ot">&lt;-</span> name_cols</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>m_big <span class="ot">&lt;-</span> <span class="fu">update</span>(m_big, drivers_chunk2)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_big)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Large data regression model: biglm(hazard ~ poly(age, 10) + poly(experience, 10) + habilit + 
    gender + city, data = drivers_chunk1)
Sample size =  200000 
                              Coef     (95%      CI)     SE      p
(Intercept)                 0.4482   0.4308   0.4655 0.0087 0.0000
poly(age, 10)1            -34.1755 -37.9337 -30.4174 1.8791 0.0000
poly(age, 10)2             -5.0181  -8.0743  -1.9619 1.5281 0.0010
poly(age, 10)3             -2.7864  -5.4427  -0.1300 1.3282 0.0359
poly(age, 10)4              7.3606   5.0422   9.6789 1.1592 0.0000
poly(age, 10)5             -5.9304  -8.2328  -3.6281 1.1512 0.0000
poly(age, 10)6              1.8641  -0.3209   4.0490 1.0925 0.0880
poly(age, 10)7              1.9233  -0.2182   4.0647 1.0707 0.0725
poly(age, 10)8             -4.2157  -6.1595  -2.2719 0.9719 0.0000
poly(age, 10)9              1.3554  -0.2981   3.0090 0.8268 0.1011
poly(age, 10)10             1.4548  -0.1152   3.0248 0.7850 0.0638
poly(experience, 10)1     -28.7063 -32.8579 -24.5546 2.0758 0.0000
poly(experience, 10)2      31.0959  28.2521  33.9398 1.4219 0.0000
poly(experience, 10)3     -15.9644 -18.2943 -13.6345 1.1649 0.0000
poly(experience, 10)4       9.4349   7.2119  11.6579 1.1115 0.0000
poly(experience, 10)5      -4.4924  -6.6014  -2.3834 1.0545 0.0000
poly(experience, 10)6       0.8428  -1.3544   3.0401 1.0986 0.4430
poly(experience, 10)7      -1.8668  -3.8951   0.1616 1.0142 0.0657
poly(experience, 10)8       0.6580  -1.3855   2.7015 1.0217 0.5196
poly(experience, 10)9      -1.0719  -3.0598   0.9159 0.9939 0.2808
poly(experience, 10)10      0.1440  -1.7450   2.0330 0.9445 0.8788
habilitS                    0.1873   0.1711   0.2034 0.0081 0.0000
genderM                     0.3127   0.3024   0.3230 0.0052 0.0000
cityBRESCIA                 0.1237   0.1029   0.1446 0.0104 0.0000
cityCOMO                    0.0437   0.0224   0.0651 0.0107 0.0000
cityCREMONA                 0.0736   0.0432   0.1040 0.0152 0.0000
cityLECCO                  -0.0201  -0.0477   0.0075 0.0138 0.1448
cityLODI                    0.0838   0.0542   0.1135 0.0148 0.0000
cityMANTOVA                 0.1884   0.1586   0.2182 0.0149 0.0000
cityMILANO                  0.1346   0.1170   0.1522 0.0088 0.0000
cityMONZA E DELLA BRIANZA  -0.0356  -0.0593  -0.0120 0.0118 0.0026
cityPAVIA                   0.2157   0.1911   0.2403 0.0123 0.0000
citySONDRIO                -0.0656  -0.1056  -0.0256 0.0200 0.0010
cityVARESE                  0.0200  -0.0024   0.0424 0.0112 0.0748</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(drivers_chunk2)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>() <span class="co"># Free unused R memory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          used (Mb) gc trigger  (Mb) limit (Mb) max used  (Mb)
Ncells 1001361 53.5    1779550  95.1         NA  1693400  90.5
Vcells 2277934 17.4   14639441 111.7      16384 18280203 139.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>drivers_chunk3 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/drivers2.csv"</span>, </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n_max =</span> <span class="dv">100000</span>, <span class="at">skip =</span> <span class="dv">200000</span>, <span class="at">col_names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(drivers_chunk3) <span class="ot">&lt;-</span> name_cols</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>m_big <span class="ot">&lt;-</span> <span class="fu">update</span>(m_big, drivers_chunk3)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_big)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Large data regression model: biglm(hazard ~ poly(age, 10) + poly(experience, 10) + habilit + 
    gender + city, data = drivers_chunk1)
Sample size =  300000 
                              Coef     (95%      CI)     SE      p
(Intercept)                 0.6383   0.6243   0.6523 0.0070 0.0000
poly(age, 10)1            -27.8917 -31.1660 -24.6175 1.6371 0.0000
poly(age, 10)2            -10.1502 -12.6710  -7.6294 1.2604 0.0000
poly(age, 10)3             -1.7411  -3.9597   0.4776 1.1093 0.1165
poly(age, 10)4              4.1168   2.2509   5.9828 0.9330 0.0000
poly(age, 10)5             -1.1767  -3.0531   0.6998 0.9382 0.2098
poly(age, 10)6              0.3420  -1.4237   2.1078 0.8829 0.6985
poly(age, 10)7             -0.1307  -1.8377   1.5763 0.8535 0.8783
poly(age, 10)8             -2.5113  -4.0484  -0.9741 0.7686 0.0011
poly(age, 10)9              1.5779   0.2341   2.9217 0.6719 0.0189
poly(age, 10)10             1.8249   0.5381   3.1117 0.6434 0.0046
poly(experience, 10)1     -31.8599 -35.4156 -28.3041 1.7779 0.0000
poly(experience, 10)2      38.1924  35.8051  40.5797 1.1937 0.0000
poly(experience, 10)3     -25.1551 -27.1025 -23.2076 0.9737 0.0000
poly(experience, 10)4      16.2344  14.4249  18.0439 0.9047 0.0000
poly(experience, 10)5      -6.6190  -8.3225  -4.9154 0.8518 0.0000
poly(experience, 10)6      -3.0139  -4.7900  -1.2378 0.8881 0.0007
poly(experience, 10)7       6.6486   5.0053   8.2918 0.8216 0.0000
poly(experience, 10)8      -8.7493 -10.4128  -7.0857 0.8318 0.0000
poly(experience, 10)9       5.1917   3.5950   6.7883 0.7983 0.0000
poly(experience, 10)10     -2.3915  -3.9164  -0.8666 0.7624 0.0017
habilitS                    0.0420   0.0295   0.0544 0.0062 0.0000
genderM                     0.3629   0.3544   0.3713 0.0042 0.0000
cityBRESCIA                 0.1227   0.1055   0.1399 0.0086 0.0000
cityCOMO                   -0.0256  -0.0440  -0.0072 0.0092 0.0053
cityCREMONA                 0.0747   0.0494   0.1000 0.0126 0.0000
cityLECCO                  -0.0529  -0.0765  -0.0292 0.0118 0.0000
cityLODI                    0.0188  -0.0071   0.0447 0.0129 0.1456
cityMANTOVA                 0.1800   0.1556   0.2044 0.0122 0.0000
cityMILANO                  0.1209   0.1064   0.1354 0.0073 0.0000
cityMONZA E DELLA BRIANZA  -0.0162  -0.0350   0.0027 0.0094 0.0858
cityPAVIA                   0.1737   0.1530   0.1944 0.0103 0.0000
citySONDRIO                -0.0412  -0.0738  -0.0086 0.0163 0.0116
cityVARESE                  0.0176  -0.0008   0.0360 0.0092 0.0558</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">object.size</span>(m_big), <span class="at">units =</span> <span class="st">"KB"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18.8 Kb</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<script src="lab1_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>